"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function performanceReport(option,fn){try{var reportData=function(){var type=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;setTimeout(function(){opt.isPage&&perforPage(),(opt.isResource||opt.isAjax)&&perforResource(),ERRORLIST&&ERRORLIST.length&&(conf.errorList=conf.errorList.concat(ERRORLIST));var w=document.documentElement.clientWidth||document.body.clientWidth,h=document.documentElement.clientHeight||document.body.clientHeight,result={time:(new Date).getTime(),addData:ADDDATA,type:type,url:location.href};!function(){var reslist=conf.resourceList,filterUrl=opt.filterUrl,newlist=[];if(reslist&&reslist.length&&filterUrl&&filterUrl.length)for(var i=0;i<reslist.length;i++){for(var begin=!1,j=0;j<filterUrl.length;j++)if(-1<reslist[i].name.indexOf(filterUrl[j])){begin=!0;break}begin||newlist.push(reslist[i])}conf.resourceList=newlist}(),1===type?result=Object.assign(result,{preUrl:conf.preUrl,errorList:conf.errorList,performance:conf.performance,resourceList:conf.resourceList,screenwidth:w,screenheight:h}):2===type?result=Object.assign(result,{resourceList:conf.resourceList,errorList:conf.errorList}):3===type&&(result=Object.assign(result,{errorList:conf.errorList,resourceList:conf.resourceList})),result=Object.assign(result,opt.add),fn&&fn(result);var reportedData={identity:1,clientInfo:{model:navigator.userAgent,screen:JSON.stringify({width:window.screen.width,height:window.screen.height})},items:[{action:opt.action,p:JSON.stringify({userId:conf.userId,appKey:opt.appKey,time:result.time}),p2:JSON.stringify({url:window.location.href}),p3:result.errorList?JSON.stringify(result.errorList):"",p4:result.performance?JSON.stringify(result.performance):"",p5:result.resourceList?JSON.stringify(result.resourceList):"",p6:JSON.stringify({os:function(){var OS="",OSArray={},UserAgent=navigator.userAgent.toLowerCase();for(var i in OSArray.Windows="Win32"==navigator.platform||"Windows"==navigator.platform,OSArray.Mac="Mac68K"==navigator.platform||"MacPPC"==navigator.platform||"Macintosh"==navigator.platform||"MacIntel"==navigator.platform,OSArray.iphone=-1<UserAgent.indexOf("iPhone"),OSArray.ipod=-1<UserAgent.indexOf("iPod"),OSArray.ipad=-1<UserAgent.indexOf("iPad"),OSArray.Android=-1<UserAgent.indexOf("Android"),OSArray)OSArray[i]&&(OS=i);return OS}(),browser:function(){var UserAgent=navigator.userAgent.toLowerCase(),browser=null,browserArray={IE:window.ActiveXObject||"ActiveXObject"in window,Chrome:-1<UserAgent.indexOf("chrome")&&-1<UserAgent.indexOf("safari"),Firefox:-1<UserAgent.indexOf("firefox"),Opera:-1<UserAgent.indexOf("opera"),Safari:-1<UserAgent.indexOf("safari")&&-1==UserAgent.indexOf("chrome"),Edge:-1<UserAgent.indexOf("edge"),QQBrowser:/qqbrowser/.test(UserAgent),WeixinBrowser:/MicroMessenger/i.test(UserAgent)};for(var i in browserArray)browserArray[i]&&(browser=i);return browser}(),ua:navigator.userAgent})}]};ajax({url:opt.domain,type:"POST",async:!0,data:JSON.stringify(reportedData),dataType:"json",success:function(data){}}),Promise.resolve().then(function(){clear()})},opt.outtime)},getLargeTime=function(){conf.page!==location.href?conf.haveAjax&&conf.haveFetch&&loadTime&&ajaxTime&&fetchTime?reportData(1):conf.haveAjax&&!conf.haveFetch&&loadTime&&ajaxTime?reportData(1):!conf.haveAjax&&conf.haveFetch&&loadTime&&fetchTime?reportData(1):conf.haveAjax||conf.haveFetch||!loadTime||reportData(1):conf.haveAjax&&conf.haveFetch&&ajaxTime&&fetchTime?reportData(2):conf.haveAjax&&!conf.haveFetch&&ajaxTime?reportData(2):!conf.haveAjax&&conf.haveFetch&&fetchTime&&reportData(2)},perforPage=function(){if(window.performance){var timing=performance.timing;conf.performance={dnst:timing.domainLookupEnd-timing.domainLookupStart||0,tcpt:timing.connectEnd-timing.connectStart||0,wit:timing.responseStart-timing.navigationStart||0,domt:timing.domContentLoadedEventEnd-timing.navigationStart||0,lodt:timing.loadEventEnd-timing.navigationStart||0,radt:timing.fetchStart-timing.navigationStart||0,rdit:timing.redirectEnd-timing.redirectStart||0,uodt:timing.unloadEventEnd-timing.unloadEventStart||0,reqt:timing.responseEnd-timing.requestStart||0,andt:timing.domComplete-timing.domInteractive||0,memory:performance.memory}}},perforResource=function(){if(!window.performance&&!window.performance.getEntries)return!1;var resource=performance.getEntriesByType("resource"),resourceList=[];if(!resource&&!resource.length)return resourceList;resource.forEach(function(item){if((opt.isAjax||"xmlhttprequest"!=item.initiatorType&&"fetchrequest"!=item.initiatorType)&&(opt.isResource||"xmlhttprequest"==item.initiatorType||"fetchrequest"===item.initiatorType)){var json={name:item.name,duration:item.duration.toFixed(2)||0,size:item.decodedBodySize||0},name=item.name?item.name.split("?")[0]:"",ajaxMsg=conf.ajaxMsg[name]||"";ajaxMsg&&(json.size=json.decodedBodySize||ajaxMsg.decodedBodySize),resourceList.push(json)}}),conf.resourceList=resourceList},fetArg=function(arg){var result={method:"GET",type:"fetchrequest"},args=Array.prototype.slice.apply(arg);if(!args||!args.length)return result;try{1===args.length?"string"==typeof args[0]?result.url=args[0]:"object"===_typeof(args[0])&&(result.url=args[0].url,result.method=args[0].method):(result.url=args[0],result.method=args[1].method||"GET",result.type=args[1].type||"fetchrequest")}catch(err){}return result},ajaxResponse=function(xhr,type){var defaults=Object.assign({},errordefo);defaults.t=(new Date).getTime(),defaults.n="ajax",defaults.msg=xhr.statusText||"ajax request error",defaults.method=xhr.method;var resourceUrl=xhr.args?xhr.args.url:xhr.responseURL;defaults.data={resourceUrl:resourceUrl,text:xhr.statusText,status:xhr.status},conf.errorList.push(defaults)},getFetchTime=function(type){conf.fetchNum+=1,conf.fetLength===conf.fetchNum&&(conf.fetchNum=conf.fetLength=0,fetchTime=(new Date).getTime()-beginTime,getLargeTime())},getAjaxTime=function(type){conf.loadNum+=1,conf.loadNum===conf.ajaxLength&&(conf.ajaxLength=conf.loadNum=0,ajaxTime=(new Date).getTime()-beginTime,getLargeTime())},clearPerformance=function(type){window.performance&&window.performance.clearResourceTimings&&(conf.haveAjax&&conf.haveFetch&&0==conf.ajaxLength&&0==conf.fetLength?clear(1):!conf.haveAjax&&conf.haveFetch&&0==conf.fetLength?clear(1):conf.haveAjax&&!conf.haveFetch&&0==conf.ajaxLength&&clear(1))},ajax=function(options){var params,xhr=null,isAsync=!0;(!1===options.async&&(isAsync=!1),xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),"GET"==options.type.toUpperCase())?(options.data&&(params=function(data){var arr=[];for(var prop in data)arr.push(prop+"="+data[prop]);return arr.join("&")}(options.data)),params?xhr.open(options.type,options.url+"?"+params,options.async):xhr.open(options.type,options.url,options.async),xhr.send()):"POST"==options.type.toUpperCase()&&(xhr.open(options.type,options.url,isAsync),xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),options.data?xhr.send(options.data):xhr.send());xhr.onreadystatechange=function(){if(4==xhr.readyState&&200==xhr.status){var result=xhr.responseText;"JSON"===options.dataType.toUpperCase()?options.success(JSON.parse(result)):options.success(result)}}},clear=function(){var type=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;window.performance&&window.performance.clearResourceTimings&&performance.clearResourceTimings(),conf.performance={},conf.errorList=[],conf.preUrl="",conf.resourceList=[],conf.page=0===type?location.href:"",conf.haveAjax=!1,conf.haveFetch=!1,conf.ajaxMsg={},ERRORLIST=[],ADDDATA={},fetchTime=ajaxTime=0},opt={userIdUrl:"",domain:"",outtime:300,filterUrl:[],isPage:!0,isAjax:!0,isResource:!0,isError:!0,add:{}};(opt=Object.assign(opt,option)).filterUrl=opt.filterUrl.concat(["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/info"]);var conf={resourceList:[],performance:{},errorList:[],fetchNum:0,loadNum:0,ajaxLength:0,fetLength:0,ajaxMsg:{},goingType:"",haveAjax:!1,haveFetch:!1,preUrl:document.referrer&&document.referrer!==location.href?document.referrer:"",page:""},errordefo={t:"",n:"js",msg:"",data:{}},beginTime=(new Date).getTime(),loadTime=0,ajaxTime=0,fetchTime=0;opt.isError&&(window.addEventListener("error",function(e){var defaults={},_target=e.target;defaults.n="resource",defaults.t=(new Date).getTime(),defaults.msg=_target.localName+" is load error",defaults.data={target:_target.localName,type:e.type,resourceUrl:_target.currentSrc||"未知路径: "+e.target.className},e.target!=window&&conf.errorList.push(defaults)},!0),window.onerror=function(msg,_url,line,col,error){var defaults=Object.assign({},errordefo);setTimeout(function(){col=col||window.event&&window.event.errorCharacter||0,defaults.msg=error&&error.stack?error.stack.toString():msg,defaults.data={resourceUrl:_url,row:line,col:col},defaults.t=(new Date).getTime(),conf.errorList.push(defaults),conf.page!==location.href||conf.haveAjax||reportData(3)},0)},window.addEventListener("unhandledrejection",function(e){var error=e&&e.reason,message=error.message||"",stack=error.stack||"",resourceUrl=void 0,col=void 0,line=void 0,errs=stack.match(/[http:|https:]\w.+[js|html](:\d+)+/g);errs&&errs.length&&(errs=(errs=(errs=errs[0]).replace(/\w.+[js|html]/g,function($1){return resourceUrl=$1,""})).split(":")),errs&&1<errs.length&&(line=parseInt(errs[1]||0),col=parseInt(errs[2]||0));var defaults=Object.assign({},errordefo);defaults.msg=message,defaults.t=(new Date).getTime(),defaults.data={resourceUrl:resourceUrl,row:line,col:col},conf.errorList.push(defaults),conf.page!==location.href||conf.haveAjax||reportData(3)}),window.addEventListener("rejectionhandled",function(event){})),addEventListener("load",function(){loadTime=(new Date).getTime()-beginTime,getLargeTime()},!1),(opt.isAjax||opt.isError)&&function(){if(window.fetch){var _fetch=fetch;window.fetch=function(){var result=fetArg(arguments);if("report-data"!==result.type){clearPerformance();var url=result.url?result.url.split("?")[0]:"";conf.ajaxMsg[url]=result,conf.fetLength=conf.fetLength+1,conf.haveFetch=!0}return _fetch.apply(this,arguments).then(function(res){if("report-data"!==result.type){try{var _url2=res.url?res.url.split("?")[0]:"";res.text().then(function(data){conf.ajaxMsg[_url2]&&(conf.ajaxMsg[_url2].decodedBodySize=data.length)})}catch(e){}return getFetchTime("success"),res}}).catch(function(err){if("report-data"!==result.type){getFetchTime("error");var defaults=Object.assign({},errordefo);return defaults.t=(new Date).getTime(),defaults.n="fetch",defaults.msg="fetch request error",defaults.method=result.method,defaults.data={resourceUrl:result.url,text:err.stack||err,status:0},conf.errorList.push(defaults),err}})}}}(),(opt.isAjax||opt.isError)&&function(proxy){function getFactory(attr){return function(){var v=this.hasOwnProperty(attr+"_")?this[attr+"_"]:this.xhr[attr],attrGetterHook=(proxy[attr]||{}).getter;return attrGetterHook&&attrGetterHook(v,this)||v}}function setFactory(attr){return function(v){var xhr=this.xhr,that=this,hook=proxy[attr];if("function"==typeof hook)xhr[attr]=function(){proxy[attr](that)||v.apply(xhr,arguments)};else{var attrSetterHook=(hook||{}).setter;v=attrSetterHook&&attrSetterHook(v,that)||v;try{xhr[attr]=v}catch(e){this[attr+"_"]=v}}}}function hookfun(fun){return function(){var args=[].slice.call(arguments);if(!proxy[fun]||!proxy[fun].call(this,args,this.xhr))return this.xhr[fun].apply(this.xhr,args)}}window._ahrealxhr=window._ahrealxhr||XMLHttpRequest,XMLHttpRequest=function(){for(var attr in this.xhr=new window._ahrealxhr,this.xhr){var type="";try{type=_typeof(this.xhr[attr])}catch(e){}"function"===type?this[attr]=hookfun(attr):Object.defineProperty(this,attr,{get:getFactory(attr),set:setFactory(attr)})}},window._ahrealxhr}({onreadystatechange:function(xhr){4===xhr.readyState&&setTimeout(function(){if("load"!==conf.goingType){conf.goingType="readychange",getAjaxTime();try{var responseURL=xhr.xhr.responseURL?xhr.xhr.responseURL.split("?")[0]:"";conf.ajaxMsg[responseURL]&&(conf.ajaxMsg[responseURL].decodedBodySize=xhr.xhr.responseText.length)}catch(err){}(xhr.status<200||300<xhr.status)&&(xhr.method=xhr.args.method,ajaxResponse(xhr))}},600)},onerror:function(xhr){getAjaxTime(),xhr.args&&(xhr.method=xhr.args.method,xhr.responseURL=xhr.args.url,xhr.statusText="ajax request error"),ajaxResponse(xhr)},onload:function(xhr){if(4===xhr.readyState){if("readychange"===conf.goingType)return;conf.goingType="load",getAjaxTime();try{var responseURL=xhr.xhr.responseURL?xhr.xhr.responseURL.split("?")[0]:"";conf.ajaxMsg[responseURL]&&(conf.ajaxMsg[responseURL].decodedBodySize=xhr.xhr.responseText.length)}catch(err){}(xhr.status<200||300<xhr.status)&&(xhr.method=xhr.args.method,ajaxResponse(xhr))}},open:function(arg,xhr){if(opt.filterUrl&&opt.filterUrl.length){var begin=!1;if(opt.filterUrl.forEach(function(item){-1!=arg[1].indexOf(item)&&(begin=!0)}),begin)return}var result={url:arg[1],method:arg[0]||"GET",type:"xmlhttprequest"};this.args=result,conf.ajaxMsg[result.url]=result,conf.ajaxLength=conf.ajaxLength+1,conf.haveAjax=!0}})}catch(err){}}window.ERRORLIST=[],window.ADDDATA={},performanceReport.addError=function(err){err={msg:err.msg,n:"js",data:{col:err.col,row:err.line,resourceUrl:err.resourceUrl}},ERRORLIST.push(err)},performanceReport.addData=function(fn){fn&&fn(ADDDATA)},Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(target,firstSource){if(null==target)throw new TypeError("Cannot convert first argument to object");for(var to=Object(target),i=1;i<arguments.length;i++){var nextSource=arguments[i];if(null!=nextSource)for(var keysArray=Object.keys(Object(nextSource)),nextIndex=0,len=keysArray.length;nextIndex<len;nextIndex++){var nextKey=keysArray[nextIndex],desc=Object.getOwnPropertyDescriptor(nextSource,nextKey);void 0!==desc&&desc.enumerable&&(to[nextKey]=nextSource[nextKey])}}return to}});